<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URL Renderer</title>
  <!-- Office.js - 确保在 Office 环境中正确加载 -->
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* 确保页面能够获取焦点 */
    html {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    body {
      position: relative;
      -webkit-overflow-scrolling: touch;
      cursor: default;
    }
    
    /* 添加可聚焦属性 */
    body[tabindex] {
      outline: none;
    }
    
    .container {
      width: 100%;
      height: 100vh;
      position: relative;
      background: #f5f5f5;
    }
    
    .iframe-container {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
      position: relative;
    }
    
    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    
    /* 简化的焦点覆盖层 */
    .focus-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: transparent;
      z-index: 10;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .focus-overlay.active {
      background: rgba(0, 122, 204, 0.1);
    }
    
    .focus-overlay.hidden {
      display: none;
    }
    
    .focus-hint {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid #007acc;
      border-radius: 8px;
      padding: 15px 25px;
      color: #007acc;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
      user-select: none;
      pointer-events: none;
    }
    
    .focus-overlay.show-hint .focus-hint {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }
    
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #666;
      font-size: 16px;
      z-index: 20;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007acc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ffebee;
      border: 1px solid #f44336;
      border-radius: 8px;
      padding: 20px;
      color: #c62828;
      text-align: center;
      max-width: 400px;
      z-index: 20;
    }
    
    .placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #999;
      font-size: 18px;
      text-align: center;
      z-index: 20;
    }
    
    .placeholder-icon {
      font-size: 48px;
      opacity: 0.5;
      margin-bottom: 15px;
    }
    
    /* 状态指示器 */
    .status-indicator {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 25;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .status-indicator.visible {
      opacity: 1;
    }
  </style>
</head>
<body tabindex="0">
  <div class="container">
    <div class="iframe-container" id="iframeContainer">
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>Loading content...</div>
      </div>
      
      <!-- 简化的焦点覆盖层 -->
      <div class="focus-overlay" id="focusOverlay">
        <div class="focus-hint">
          👆 Click to activate content
        </div>
      </div>
      
      <!-- 状态指示器 -->
      <div class="status-indicator" id="statusIndicator">
        Initializing...
      </div>
    </div>
  </div>

  <script>
    // Default URL if no parameter is provided
    const DEFAULT_URL = 'https://mashellhan.github.io/exceldash/dashboard_example.html';
    
    let currentIframe = null;
    let focusOverlay = null;
    let statusIndicator = null;
    let isIframeFocused = false;
    let isOfficeEnvironment = false;
    let pageInitialized = false;
    
    // 日志功能
    function debugLog(message, data = null) {
      const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
      console.log(`[${timestamp}] ${message}`, data || '');
      
      if (statusIndicator) {
        statusIndicator.textContent = message;
        statusIndicator.classList.add('visible');
        setTimeout(() => {
          statusIndicator.classList.remove('visible');
        }, 3000);
      }
    }
    
    // 检查 Office.js 环境
    function checkOfficeEnvironment() {
      if (typeof Office !== 'undefined') {
        debugLog('Office.js detected - running in Office environment');
        return true;
      } else {
        debugLog('Running in standalone browser mode');
        return false;
      }
    }
    
    // Office.js 初始化（如果可用）
    if (typeof Office !== 'undefined') {
      Office.onReady((info) => {
        isOfficeEnvironment = true;
        debugLog('Office.js initialized', {
          host: info.host,
          platform: info.platform
        });
        
        // 确保页面能够接收焦点
        ensurePageFocus();
        initializeApp();
      });
    } else {
      // 非 Office 环境直接初始化
      debugLog('Non-Office environment - direct initialization');
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }
    }
    
    // 确保页面能够获取焦点
    function ensurePageFocus() {
      debugLog('Ensuring page focus capability...');
      
      // 设置页面为可聚焦
      document.body.setAttribute('tabindex', '0');
      document.body.focus();
      
      // 添加页面级别的事件监听器
      document.addEventListener('click', () => {
        debugLog('Page clicked - ensuring focus');
        document.body.focus();
      }, true);
      
      document.addEventListener('mousedown', () => {
        debugLog('Page mousedown - ensuring focus');
        document.body.focus();
      }, true);
      
      // 键盘事件监听
      document.addEventListener('keydown', (e) => {
        debugLog('Page keydown detected', e.key);
      });
      
      // 窗口焦点事件
      window.addEventListener('focus', () => {
        debugLog('Window gained focus');
        if (currentIframe && !isIframeFocused) {
          setTimeout(() => attemptIframeFocus(), 100);
        }
      });
      
      debugLog('Page focus handlers established');
    }
    
    // Get target URL from various sources
    function getTargetUrl() {
      // Priority 1: URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      let targetUrl = urlParams.get('targetUrl') || 
                     urlParams.get('url') || 
                     urlParams.get('src') || 
                     urlParams.get('source') || 
                     urlParams.get('link') ||
                     urlParams.get('target');
      
      // Priority 2: Hash fragment
      if (!targetUrl && window.location.hash) {
        const hash = window.location.hash.substring(1);
        if (isValidUrl(hash)) {
          targetUrl = hash;
        }
      }
      
      // Priority 3: Default URL
      return targetUrl || DEFAULT_URL;
    }
    
    // Validate URL
    function isValidUrl(string) {
      try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch (_) {
        return false;
      }
    }
    
    // Show error message
    function showError(message) {
      const container = document.getElementById('iframeContainer');
      container.innerHTML = `
        <div class="error">
          <div style="font-weight: bold; margin-bottom: 10px;">⚠️ Error</div>
          <div>${message}</div>
        </div>
      `;
      debugLog('Error displayed: ' + message);
    }
    
    // Show placeholder
    function showPlaceholder(message) {
      const container = document.getElementById('iframeContainer');
      container.innerHTML = `
        <div class="placeholder">
          <div class="placeholder-icon">🌐</div>
          <div>${message}</div>
        </div>
      `;
    }
    
    // 尝试聚焦 iframe
    function attemptIframeFocus() {
      if (!currentIframe) return;
      
      debugLog('Attempting to focus iframe...');
      
      try {
        // 确保页面先有焦点
        document.body.focus();
        
        // 然后聚焦 iframe
        currentIframe.focus();
        
        // 尝试聚焦 iframe 内容窗口
        if (currentIframe.contentWindow) {
          try {
            currentIframe.contentWindow.focus();
          } catch (e) {
            debugLog('Cannot focus iframe contentWindow due to CORS');
          }
        }
        
        isIframeFocused = true;
        debugLog('Iframe focus attempt completed');
        
        // 隐藏焦点覆盖层
        if (focusOverlay) {
          focusOverlay.classList.add('hidden');
        }
        
      } catch (error) {
        debugLog('Failed to focus iframe', error.message);
      }
    }
    
    // 设置焦点覆盖层
    function setupFocusOverlay() {
      focusOverlay = document.getElementById('focusOverlay');
      
      if (focusOverlay) {
        debugLog('Setting up focus overlay...');
        
        // 点击事件
        focusOverlay.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          debugLog('Focus overlay clicked');
          attemptIframeFocus();
        });
        
        // 鼠标悬停显示提示
        focusOverlay.addEventListener('mouseenter', () => {
          focusOverlay.classList.add('show-hint');
        });
        
        focusOverlay.addEventListener('mouseleave', () => {
          focusOverlay.classList.remove('show-hint');
        });
        
        // 5秒后自动显示提示
        setTimeout(() => {
          if (!isIframeFocused && focusOverlay) {
            focusOverlay.classList.add('show-hint');
            debugLog('Auto-showing focus hint');
          }
        }, 5000);
      }
    }
    
    // Load URL in iframe
    function loadUrl(url) {
      debugLog('Loading URL: ' + url);
      
      if (!isValidUrl(url)) {
        showError(`Invalid URL: ${url}`);
        return;
      }
      
      const container = document.getElementById('iframeContainer');
      const loading = document.getElementById('loading');
      
      // Remove existing iframe
      if (currentIframe) {
        currentIframe.remove();
      }
      
      // Create new iframe
      currentIframe = document.createElement('iframe');
      currentIframe.src = url;
      currentIframe.style.display = 'none';
      
      // 设置 iframe 属性
      currentIframe.setAttribute('allow', 'autoplay; camera; microphone; geolocation; fullscreen');
      currentIframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-top-navigation-by-user-activation allow-pointer-lock');
      currentIframe.setAttribute('tabindex', '0');
      currentIframe.setAttribute('role', 'document');
      currentIframe.setAttribute('aria-label', 'Embedded content');
      
      // Handle iframe load
      currentIframe.onload = () => {
        loading.style.display = 'none';
        currentIframe.style.display = 'block';
        debugLog('Content loaded successfully');
        
        // 设置焦点处理
        setupFocusOverlay();
        
        // 自动尝试聚焦
        setTimeout(() => {
          if (!isIframeFocused) {
            attemptIframeFocus();
          }
        }, 1000);
      };
      
      // Handle iframe error
      currentIframe.onerror = () => {
        loading.style.display = 'none';
        showError(`Failed to load content: ${url}`);
      };
      
      // 监听 iframe 焦点事件
      currentIframe.addEventListener('focus', () => {
        isIframeFocused = true;
        debugLog('Iframe gained focus');
      });
      
      currentIframe.addEventListener('blur', () => {
        isIframeFocused = false;
        debugLog('Iframe lost focus');
      });
      
      // Handle load timeout
      const loadTimeout = setTimeout(() => {
        if (loading.style.display !== 'none') {
          loading.style.display = 'none';
          if (currentIframe.style.display === 'none') {
            currentIframe.style.display = 'block';
            debugLog('Content loaded with timeout');
            setupFocusOverlay();
          }
        }
      }, 10000); // 10 second timeout
      
      // Clear timeout when iframe loads
      currentIframe.addEventListener('load', () => {
        clearTimeout(loadTimeout);
      });
      
      container.appendChild(currentIframe);
    }
    
    // Initialize app
    function initializeApp() {
      if (pageInitialized) return;
      pageInitialized = true;
      
      debugLog('Initializing application...');
      
      // 获取状态指示器引用
      statusIndicator = document.getElementById('statusIndicator');
      
      // 确保页面焦点
      if (!isOfficeEnvironment) {
        ensurePageFocus();
      }
      
      const targetUrl = getTargetUrl();
      
      debugLog('Target URL: ' + targetUrl);
      debugLog('Office Environment: ' + isOfficeEnvironment);
      
      if (targetUrl) {
        loadUrl(targetUrl);
      } else {
        showPlaceholder('No URL specified');
      }
    }
    
    // Handle window resize
    window.addEventListener('resize', () => {
      if (currentIframe) {
        // Force iframe to recalculate its size
        currentIframe.style.height = '99%';
        setTimeout(() => {
          currentIframe.style.height = '100%';
        }, 1);
      }
    });
    
    // 添加全局点击监听器来确保焦点
    document.addEventListener('click', (e) => {
      debugLog('Document clicked');
      if (!isIframeFocused && currentIframe) {
        setTimeout(() => attemptIframeFocus(), 100);
      }
    }, true);
    
    // 页面可见性变化处理
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentIframe && !isIframeFocused) {
        debugLog('Page became visible - attempting iframe focus');
        setTimeout(() => attemptIframeFocus(), 500);
      }
    });
  </script>
</body>
</html>
