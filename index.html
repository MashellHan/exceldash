<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Excel People‑Style Graph (Binding Demo)</title>
  <!-- Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <!-- ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    body{font-family:Segoe UI,Arial,sans-serif;margin:0;padding:16px;background:#f7f9fc}
    #chart{width:100%;height:420px;border:1px solid #e1e4e8;border-radius:6px;background:#fff}
    button{padding:8px 18px;font-size:14px;border:none;border-radius:4px;cursor:pointer;background:#4361ee;color:#fff;margin-bottom:12px}
    button:hover{opacity:.9}
    #status{margin-left:12px;color:#666;font-size:13px}
  </style>
</head>
<body>
  <button id="bind">Bind Selection & Draw</button><span id="status"></span>
  <div id="chart"></div>

  <script>
    let bindingId = "peopleData";
    let chart = null;

    Office.onReady(() => {
      document.getElementById("bind").onclick = addOrRebind;
    });

    function addOrRebind() {
      Office.context.document.bindings.addFromSelectionAsync(
        Office.BindingType.Matrix,
        { id: bindingId },
        result => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            setStatus("✅ Bound to selection – listening for changes…");
            // attach change handler only once
            const binding = result.value;
            binding.addHandlerAsync(
              Office.EventType.BindingDataChanged,
              () => refreshChart(binding)
            );
            refreshChart(binding);
          } else {
            // if binding exists already, just get it
            Office.context.document.bindings.getByIdAsync(bindingId, r => {
              if (r.status === Office.AsyncResultStatus.Succeeded) {
                refreshChart(r.value);
              } else {
                setStatus("⚠️ Select a 2‑column range then click again.");
              }
            });
          }
        }
      );
    }

    function refreshChart(binding) {
      binding.getDataAsync({ coercionType: Office.CoercionType.Matrix }, res => {
        if (res.status !== Office.AsyncResultStatus.Succeeded) {
          setStatus("Failed to read data: " + res.error.message);
          return;
        }
        const matrix = res.value; // [[Category, Value], ...]
        if (!Array.isArray(matrix) || matrix.length < 2) {
          setStatus("Select at least 2 rows (header + data)");
          return;
        }
        const categories = matrix.slice(1).map(r => r[0]);
        const values = matrix.slice(1).map(r => Number(r[1]) || 0);
        renderChart(categories, values);
      });
    }

    function renderChart(labels, vals) {
      if (!chart) {
        chart = echarts.init(document.getElementById("chart"));
      }
      const option = {
        tooltip: { trigger: "axis", formatter: params => `${params[0].name}: ${params[0].value}` },
        xAxis: { type: "category", data: labels, axisLabel: { rotate: 20 } },
        yAxis: { type: "value" },
        series: [{
          name: "People Count",
          data: vals,
          type: "bar",
          itemStyle: {
            color: "#4361ee",
            borderRadius: [4,4,0,0]
          }
        }],
        animationDuration: 500
      };
      chart.setOption(option);
      setStatus(`Last updated: ${new Date().toLocaleTimeString()}`);
    }

    function setStatus(msg){document.getElementById("status").textContent=msg;}
  </script>
</body>
</html>
