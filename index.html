<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URL Renderer</title>
  <!-- Office.js for Excel Add-in compatibility -->
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      outline: none;
      cursor: default;
    }
    
    .container {
      width: 100%;
      height: 100vh;
      position: relative;
      background: #f5f5f5;
    }
    
    .iframe-container {
      width: 100%;
      height: 100%;
      background: white;
    }
    
    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #666;
      font-size: 16px;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007acc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error, .placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
    }
    
    .error {
      background: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
    }
    
    .placeholder {
      color: #999;
      font-size: 18px;
    }
    
    .placeholder-icon {
      font-size: 48px;
      opacity: 0.5;
      margin-bottom: 15px;
    }
  </style>
</head>
<body tabindex="0">
  <div class="container">
    <div class="iframe-container" id="iframeContainer">
      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>Loading content...</div>
      </div>
    </div>
  </div>

  <script>
    const DEFAULT_URL = 'https://mashellhan.github.io/exceldash/README.md';
    
    let currentIframe = null;
    let isOfficeEnvironment = false;
    
    // Get target URL from URL parameters or Office Add-in
    function getTargetUrl() {
      // Check URL parameters first
      const urlParams = new URLSearchParams(window.location.search);
      let targetUrl = urlParams.get('targetUrl') || 
                     urlParams.get('url') 
      
      if (targetUrl) {
        return targetUrl;
      }
      
      // Check hash fragment
      if (window.location.hash) {
        const hash = window.location.hash.substring(1);
        if (isValidUrl(hash)) {
          return hash;
        }
      }
      
      // Try to get from Office Add-in settings
      if (isOfficeEnvironment) {
        console.log("office roamingsettings:", Office.context.roamingSettings);
        const settings = Office.context.document.settings;
        console.log("office.context.document.settings:", settings);

        try {
          if (Office.context && Office.context.roamingSettings) {
            targetUrl = Office.context.roamingSettings.get('targetUrl');

            if (targetUrl) {
              return targetUrl;
            }
          }
        } catch (error) {
          console.log('Could not read Office settings:', error.message);
        }
      }
      
      return DEFAULT_URL;
    }
    
    // Validate URL
    function isValidUrl(string) {
      try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
      } catch (_) {
        return false;
      }
    }
    
    // Show error message
    function showError(message) {
      document.getElementById('iframeContainer').innerHTML = `
        <div class="error">
          <div style="font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è Error</div>
          <div>${message}</div>
        </div>
      `;
    }
    
    // Show placeholder
    function showPlaceholder(message) {
      document.getElementById('iframeContainer').innerHTML = `
        <div class="placeholder">
          <div class="placeholder-icon">üåê</div>
          <div>${message}</div>
        </div>
      `;
    }
    
    // Load URL in iframe
    function loadUrl(url) {
      console.log('Loading URL:', url);
      
      if (!isValidUrl(url)) {
        showError(`Invalid URL: ${url}`);
        return;
      }
      
      const container = document.getElementById('iframeContainer');
      const loading = document.getElementById('loading');
      
      // Remove existing iframe
      if (currentIframe) {
        currentIframe.remove();
      }
      
      // Create new iframe
      currentIframe = document.createElement('iframe');
      currentIframe.src = url;
      currentIframe.style.display = 'none';
      
      // Set iframe attributes
      currentIframe.setAttribute('allow', 'autoplay; camera; microphone; geolocation; fullscreen');
      currentIframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-top-navigation-by-user-activation');
      currentIframe.setAttribute('tabindex', '0');
      
      // Handle iframe load
      currentIframe.onload = () => {
        loading.style.display = 'none';
        currentIframe.style.display = 'block';
        console.log('Content loaded successfully');
        
        // Focus iframe for Excel Add-in compatibility
        setTimeout(() => {
          document.body.focus();
          currentIframe.focus();
        }, 500);
      };
      
      // Handle iframe error
      currentIframe.onerror = () => {
        loading.style.display = 'none';
        showError(`Failed to load content: ${url}`);
      };
      
      // Handle load timeout
      setTimeout(() => {
        if (loading.style.display !== 'none') {
          loading.style.display = 'none';
          if (currentIframe.style.display === 'none') {
            currentIframe.style.display = 'block';
            console.log('Content loaded with timeout');
          }
        }
      }, 10000);
      
      container.appendChild(currentIframe);
    }
    
    // Initialize app
    function initializeApp() {
      console.log('Initializing app...');
      
      // Ensure page can receive focus
      document.body.setAttribute('tabindex', '0');
      document.body.focus();
      
      const targetUrl = getTargetUrl();
      console.log('Target URL:', targetUrl);
      console.log('Office Environment:', isOfficeEnvironment);
      
      if (targetUrl) {
        loadUrl(targetUrl);
      } else {
        showPlaceholder('No URL specified');
      }
    }
    
    // Office.js initialization (if available)
    if (typeof Office !== 'undefined') {
      Office.onReady((info) => {
        isOfficeEnvironment = true;
        console.log('Office.js initialized:', info.host, info.platform);
        initializeApp();
      });
    } else {
      // Non-Office environment
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }
    }
    
    // Handle window resize
    window.addEventListener('resize', () => {
      if (currentIframe) {
        currentIframe.style.height = '99%';
        setTimeout(() => {
          currentIframe.style.height = '100%';
        }, 1);
      }
    });
    
    // Ensure focus on user interaction
    document.addEventListener('click', () => {
      if (currentIframe) {
        document.body.focus();
        currentIframe.focus();
      }
    });
  </script>
</body>
</html>
